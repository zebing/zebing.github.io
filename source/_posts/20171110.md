---
title: web文件上传全解
date: 2017-11-10 14:48
tags: [javascript,前端]
---
### 前语
在web工程开发中，由于系统的需求，或多或少都需要用到文件上传。如图片，压缩文件等。文件上传不像普通的表单上传那样，比较简单。文件上传是一个比较复杂的过程。下面将讲解文件上传的几种方式。
<!-- more -->

#### 1.form表单提交
传统的文件上传方式，通过form表单提交来上传文件。这种方是文件上传最简单最简便的方式。但它的缺点也是最大的。form表单提交给服务器，服务器接收并处理传来的表单，然后返回一个新的网页。这个做法浪费了许多带宽，因为在前后两个页面中的大部分HTML代码往往是相同的。由于每次应用的交互都需要向服务器发送请求，应用的响应时间就依赖于服务器的响应时间。导致性能贼差。因此不推荐使用。

示例代码
``` html
<form action="file.php" method="post" enctype="multipart/form-data">
	<input type="file" name="file">
	<button>提交</button>
</form>
```
### 2.ajax,formData上传
通过jquery中的ajax方法上传文件，因不用刷新页面，所以不会额外影响性能。但是需要用到formData来处理表单。首先new FormData
``` javascrip
new FormData(document.getElementById("form"))
```
然后通过ajax传输
``` javascript
	var fd = new FormData(document.getElementById("form"));
  $.ajax({
    type:"post",
    url:"file.php",
    data: fd,
    processData: false,
    contentType: false,
    success: function (data) {
      console.log(data)
    }
  });
```
需要注意的是 processData: false,ajax不需要对数据做处理。contentType: false,因为是由form表单构造的FormData对象，且已经声明了属性enctype="multipart/form-data"，所以这里设置为false。

### 3.XMLHttpRequest, formData上传
XMLHttpRequest,formData上传和ajax很相似，因为ajax就是通过XMLHttpRequest封装的，差别就是上传数据要自己发送，且不用设置header,代码如下
``` javascript
	var fd = new FormData(document.getElementById("form"));
  var xhr = new XMLHttpRequest();

   xhr.addEventListener('load', function(event) {
    console.log('发送成功');
  });
  xhr.open('post', 'file.php', true);
  xhr.send(fd);
```
### 4.XMLHttpRequest, 不用formData上传
XMLHttpRequest, 不用formData上传相对来说较复杂，体现在上传的文件要先通过fileReader转换为二进制字符串，还要构造出form-data格式字符串，然后再通过XMLHttpRequest发送，且发送的时候需要设置header。代码如下
``` javascript 
	var file = document.getElementById("file");
	var reader = new FileReader();
	reader.readAsDataURL(file.files[0]);

	reader.addEventListener("load", function () {
    var xhr      = new XMLHttpRequest();
    var boundary = Math.random().toString(16).substring(2);;
    var data     = "";

    data += "------" + boundary + "\r\n";
    data += 'content-disposition: form-data; '
          + 'name="'         + file.name          + '"; '
          + 'filename="'     + file.files[0].name + '"\r\n';
    data += 'Content-Type: ' + file.files[0].type + '\r\n';
    data += '\r\n';
    data += reader.result + '\r\n';
    data += "------" + boundary + "------";

    xhr.addEventListener('load', function(event) {
      console.log('发送成功');
    });

    xhr.open('POST', 'file.php');
    xhr.setRequestHeader('Content-Type','multipart/form-data; boundary=----' + boundary);
    xhr.send(data);
	}); 
```